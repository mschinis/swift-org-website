I"žB<p>The <code class="language-plaintext highlighter-rouge">swift run</code> command has a new <code class="language-plaintext highlighter-rouge">--repl</code> option which launches the Swift REPL with support for importing library targets of a package.</p>

<p>The Swift distribution comes with a REPL for the Swift language. The Swift REPL is a great tool for experimenting with Swift code without needing to create a throwaway Swift package or Xcode project. The REPL can be launched by running the <code class="language-plaintext highlighter-rouge">swift</code> command without any arguments.</p>

<p>The Swift REPL allows you to import the core libraries like <code class="language-plaintext highlighter-rouge">Foundation</code>, <code class="language-plaintext highlighter-rouge">Dispatch</code> and system modules like <code class="language-plaintext highlighter-rouge">Darwin</code> on macOS and <code class="language-plaintext highlighter-rouge">Glibc</code> on Linux. In fact, the REPL allows you to import any Swift module as long as it can correctly find and load them using the compiler arguments that are provided while launching the REPL. Swift Package Manager leverages this feature and launches the REPL with the compiler arguments that are required for importing library targets of a package.</p>

<h2 id="examples">Examples</h2>

<p>Letâ€™s explore the new functionality using some examples:</p>

<h3 id="yams"><a href="https://github.com/jpsim/Yams">Yams</a></h3>

<p>Yams is a Swift package for working with YAML.</p>

<p>Clone the package and launch REPL using <code class="language-plaintext highlighter-rouge">swift run --repl</code>:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/jpsim/Yams
<span class="nv">$ </span><span class="nb">cd </span>Yams
<span class="nv">$ </span>swift run <span class="nt">--repl</span>
</code></pre></div></div>

<p>This should compile the package and launch the Swift REPL. Letâ€™s try using the <code class="language-plaintext highlighter-rouge">dump</code> method which converts an object to YAML:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="mi">1</span><span class="o">&gt;</span> <span class="kd">import</span> <span class="kt">Yams</span>

  <span class="mi">2</span><span class="o">&gt;</span> <span class="k">let</span> <span class="nv">yaml</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Yams</span><span class="o">.</span><span class="nf">dump</span><span class="p">(</span><span class="nv">object</span><span class="p">:</span> <span class="p">[</span><span class="s">"foo"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s">"bar"</span><span class="p">:</span> <span class="mi">3</span><span class="p">])</span>
<span class="nv">yaml</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"bar: 3</span><span class="se">\n</span><span class="s">foo:</span><span class="se">\n</span><span class="s">- 1</span><span class="se">\n</span><span class="s">- 2</span><span class="se">\n</span><span class="s">- 3</span><span class="se">\n</span><span class="s">- 4</span><span class="se">\n</span><span class="s">"</span>

  <span class="mi">3</span><span class="o">&gt;</span> <span class="nf">print</span><span class="p">(</span><span class="n">yaml</span><span class="p">)</span>
<span class="nv">bar</span><span class="p">:</span> <span class="mi">3</span>
<span class="nv">foo</span><span class="p">:</span>
<span class="o">-</span> <span class="mi">1</span>
<span class="o">-</span> <span class="mi">2</span>
<span class="o">-</span> <span class="mi">3</span>
<span class="o">-</span> <span class="mi">4</span>
</code></pre></div></div>

<p>Similarly, we can use the <code class="language-plaintext highlighter-rouge">load</code> method to convert the string back into an object:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="mi">4</span><span class="o">&gt;</span> <span class="k">let</span> <span class="nv">object</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Yams</span><span class="o">.</span><span class="nf">load</span><span class="p">(</span><span class="nv">yaml</span><span class="p">:</span> <span class="n">yaml</span><span class="p">)</span>
<span class="nv">object</span><span class="p">:</span> <span class="kt">Any</span><span class="p">?</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">key</span><span class="o">/</span><span class="n">value</span> <span class="n">pairs</span> <span class="p">{</span>
  <span class="o">...</span>
<span class="p">}</span>

  <span class="mi">5</span><span class="o">&gt;</span> <span class="nf">print</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
<span class="kt">Optional</span><span class="p">([</span><span class="kt">AnyHashable</span><span class="p">(</span><span class="s">"bar"</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span> <span class="kt">AnyHashable</span><span class="p">(</span><span class="s">"foo"</span><span class="p">):</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])</span>
</code></pre></div></div>

<h3 id="vapors-http">Vaporâ€™s <a href="https://github.com/vapor/http">HTTP</a></h3>

<p>The <a href="http://vapor.codes">Vapor</a> project has a <a href="https://github.com/vapor/http">HTTP</a> package built on top of <a href="https://github.com/apple/swift-nio">SwiftNIO</a> package.</p>

<p>Clone the package and launch REPL using <code class="language-plaintext highlighter-rouge">swift run --repl</code>:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/vapor/http
<span class="nv">$ </span><span class="nb">cd </span>http
<span class="nv">$ </span>swift run <span class="nt">--repl</span>
</code></pre></div></div>

<p>Letâ€™s make a <code class="language-plaintext highlighter-rouge">GET</code> request using the <code class="language-plaintext highlighter-rouge">HTTPClient</code> type:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="mi">1</span><span class="o">&gt;</span> <span class="kd">import</span> <span class="kt">HTTP</span>
  <span class="mi">2</span><span class="o">&gt;</span> <span class="k">let</span> <span class="nv">worker</span> <span class="o">=</span> <span class="kt">MultiThreadedEventLoopGroup</span><span class="p">(</span><span class="nv">numberOfThreads</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
  <span class="mi">3</span><span class="o">&gt;</span> <span class="k">let</span> <span class="nv">client</span> <span class="o">=</span> <span class="kt">HTTPClient</span><span class="o">.</span><span class="nf">connect</span><span class="p">(</span><span class="nv">hostname</span><span class="p">:</span> <span class="s">"httpbin.org"</span><span class="p">,</span> <span class="nv">on</span><span class="p">:</span> <span class="n">worker</span><span class="p">)</span><span class="o">.</span><span class="nf">wait</span><span class="p">()</span>
  <span class="mi">4</span><span class="o">&gt;</span> <span class="k">let</span> <span class="nv">httpReq</span> <span class="o">=</span> <span class="kt">HTTPRequest</span><span class="p">(</span><span class="nv">method</span><span class="p">:</span> <span class="o">.</span><span class="kt">GET</span><span class="p">,</span> <span class="nv">url</span><span class="p">:</span> <span class="s">"/json"</span><span class="p">)</span>
  <span class="mi">5</span><span class="o">&gt;</span> <span class="k">let</span> <span class="nv">httpRes</span> <span class="o">=</span> <span class="k">try</span> <span class="n">client</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="n">httpReq</span><span class="p">)</span><span class="o">.</span><span class="nf">wait</span><span class="p">()</span>

  <span class="mi">6</span><span class="o">&gt;</span> <span class="nf">print</span><span class="p">(</span><span class="n">httpRes</span><span class="p">)</span>
<span class="kt">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="kt">OK</span>
<span class="kt">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="kt">Server</span><span class="p">:</span> <span class="n">gunicorn</span><span class="o">/</span><span class="mf">19.9</span><span class="o">.</span><span class="mi">0</span>
<span class="kt">Date</span><span class="p">:</span> <span class="kt">Sun</span><span class="p">,</span> <span class="mi">30</span> <span class="kt">Sep</span> <span class="mi">2018</span> <span class="mi">21</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">41</span> <span class="kt">GMT</span>
<span class="kt">Content</span><span class="o">-</span><span class="k">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="kt">Content</span><span class="o">-</span><span class="kt">Length</span><span class="p">:</span> <span class="mi">429</span>
<span class="kt">Access</span><span class="o">-</span><span class="kt">Control</span><span class="o">-</span><span class="kt">Allow</span><span class="o">-</span><span class="kt">Origin</span><span class="p">:</span> <span class="o">*</span>
<span class="kt">Access</span><span class="o">-</span><span class="kt">Control</span><span class="o">-</span><span class="kt">Allow</span><span class="o">-</span><span class="kt">Credentials</span><span class="p">:</span> <span class="kc">true</span>
<span class="kt">Via</span><span class="p">:</span> <span class="mf">1.1</span> <span class="n">vegur</span>
<span class="p">{</span>
  <span class="s">"slideshow"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"author"</span><span class="p">:</span> <span class="s">"Yours Truly"</span><span class="p">,</span>
    <span class="s">"date"</span><span class="p">:</span> <span class="s">"date of publication"</span><span class="p">,</span>
    <span class="s">"slides"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s">"title"</span><span class="p">:</span> <span class="s">"Wake up to WonderWidgets!"</span><span class="p">,</span>
        <span class="s">"type"</span><span class="p">:</span> <span class="s">"all"</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s">"items"</span><span class="p">:</span> <span class="p">[</span>
          <span class="s">"Why &lt;em&gt;WonderWidgets&lt;/em&gt; are great"</span><span class="p">,</span>
          <span class="s">"Who &lt;em&gt;buys&lt;/em&gt; WonderWidgets"</span>
        <span class="p">],</span>
        <span class="s">"title"</span><span class="p">:</span> <span class="s">"Overview"</span><span class="p">,</span>
        <span class="s">"type"</span><span class="p">:</span> <span class="s">"all"</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"title"</span><span class="p">:</span> <span class="s">"Sample Slide Show"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can use Foundationâ€™s <code class="language-plaintext highlighter-rouge">JSONSerialization</code> to parse the response:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="mi">7</span><span class="o">&gt;</span> <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">jsonObject</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">httpRes</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">data</span><span class="o">!</span><span class="p">)</span> <span class="k">as!</span> <span class="kt">NSDictionary</span>
<span class="nv">result</span><span class="p">:</span> <span class="kt">NSDictionary</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">key</span><span class="o">/</span><span class="n">value</span> <span class="n">pair</span> <span class="p">{</span>
  <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s">"slideshow"</span>
    <span class="n">value</span> <span class="o">=</span> <span class="mi">4</span> <span class="n">key</span><span class="o">/</span><span class="n">value</span> <span class="n">pairs</span> <span class="p">{</span>
      <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">"slides"</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">elements</span>
      <span class="p">}</span>
      <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">"author"</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"Yours Truly"</span>
      <span class="p">}</span>
      <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">"title"</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"Sample Slide Show"</span>
      <span class="p">}</span>
      <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">"date"</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"date of publication"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="implementation-details">Implementation Details</h2>

<p>Using the REPL with a Swift package requires two pieces of information in order to construct the REPL arguments. The first piece is providing the header search paths for the library targets and their dependencies. For Swift targets, this means providing the path to the moduleâ€™s <code class="language-plaintext highlighter-rouge">.swiftmodule</code> file and for C targets, we need the path of the directory containing the targetâ€™s modulemap file. The second piece is constructing a shared dynamic library that contains all of the library targets. This will allow the REPL to load the required symbols at runtime. SwiftPM does this by synthesizing a special product that contains all of the library targets of the root package. This special product is only built when using the <code class="language-plaintext highlighter-rouge">--repl</code> option and doesnâ€™t affect other package manager operations.</p>

<p>Checkout the <a href="https://github.com/apple/swift-package-manager/pull/1793">pull request</a> that implemented this functionality for full implementation details!</p>

<h2 id="conclusion">Conclusion</h2>

<p>REPL support for Swift packages will further enhance the REPL environment and enable easier experimentation for library package authors and consumers. The feature is available to try in the latest trunk <a href="https://swift.org/download/#snapshots">snapshot</a>. If you find bugs or have enhancement requests, please file a <a href="https://github.com/apple/swift-package-manager/blob/master/Documentation/Resources.md#reporting-a-good-swiftpm-bug">JIRA</a>!</p>

<h2 id="questions">Questions?</h2>

<p>If you have questions and are interested in learning more, check out the related <a href="https://forums.swift.org/t/swift-org-blog-repl-support-for-swift-packages/16792">discussion thread</a> in the Swift forums.</p>
:ET