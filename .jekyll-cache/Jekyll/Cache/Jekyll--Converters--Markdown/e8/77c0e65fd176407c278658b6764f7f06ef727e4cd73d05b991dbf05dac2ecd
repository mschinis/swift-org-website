I"x!<p>It is my pleasure to announce a new open source project for the Swift server ecosystem, <a href="https://github.com/swift-server/swift-service-lifecycle">Swift Service Lifecycle</a>. Service Lifecycle is a Swift package designed to help server applications, also known as services, manage their startup and shutdown sequences.</p>

<h2 id="what-is-it">What is it?</h2>

<p>Most services have startup and shutdown workflow-logic which is often sensitive to failure and hard to get right. Startup sequences include actions like initializing thread pools, running data migrations, warming up caches, and other forms of state initialization before taking traffic or accepting events. Shutdown sequences include freeing up resources that hold on to file descriptors or other system resources that may leak if not cleared correctly.</p>

<p>Today, server applications and frameworks must find ways to address the need on their own, which could be error prone. To make things safer and easier, Service Lifecycle codifies this common need in a safe, reusable and framework-agnostic way. It is designed to be integrated with any server framework or directly in a server application‚Äôs <code class="language-plaintext highlighter-rouge">main</code>.</p>

<h2 id="how-does-it-work">How does it work?</h2>

<p>The recommended way of using this library is creating a <code class="language-plaintext highlighter-rouge">ServiceLifecycle</code> instance in your server application‚Äôs <code class="language-plaintext highlighter-rouge">main</code>, and register <code class="language-plaintext highlighter-rouge">LifecycleTasks</code> with it. Upon calling the <code class="language-plaintext highlighter-rouge">start</code> function, <code class="language-plaintext highlighter-rouge">ServiceLifecycle</code>  will start these tasks in the order they were registered.</p>

<p>By default, <code class="language-plaintext highlighter-rouge">ServiceLifecycle</code> also registers a <code class="language-plaintext highlighter-rouge">Signal</code> handler that traps <code class="language-plaintext highlighter-rouge">INT</code> and <code class="language-plaintext highlighter-rouge">TERM</code> , which are typical <code class="language-plaintext highlighter-rouge">Signal</code>s used in modern deployment platforms to communicate shutdown request. The shutdown sequence begins once the <code class="language-plaintext highlighter-rouge">Signal</code> is captured, and the <code class="language-plaintext highlighter-rouge">LifecycleTasks</code> are shut down in the reverse order they have been registered in.</p>

<h3 id="example">Example</h3>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Import the package.</span>
<span class="kd">import</span> <span class="kt">Lifecycle</span>

<span class="c1">// Initialize the `Lifecycle` container.</span>
<span class="k">var</span> <span class="nv">lifecycle</span> <span class="o">=</span> <span class="kt">ServiceLifecycle</span><span class="p">()</span>

<span class="c1">// Register a resource that should be shut down when the application exits.</span>
<span class="c1">//</span>
<span class="c1">// In this case, we are registering a SwiftNIO `EventLoopGroup`</span>
<span class="c1">// and passing its `syncShutdownGracefully` function to be called on shutdown.</span>
<span class="k">let</span> <span class="nv">eventLoopGroup</span> <span class="o">=</span> <span class="kt">MultiThreadedEventLoopGroup</span><span class="p">(</span><span class="nv">numberOfThreads</span><span class="p">:</span> <span class="kt">System</span><span class="o">.</span><span class="n">coreCount</span><span class="p">)</span>
<span class="n">lifecycle</span><span class="o">.</span><span class="nf">registerShutdown</span><span class="p">(</span>
    <span class="nv">name</span><span class="p">:</span> <span class="s">"eventLoopGroup"</span><span class="p">,</span>
    <span class="o">.</span><span class="nf">sync</span><span class="p">(</span><span class="n">eventLoopGroup</span><span class="o">.</span><span class="n">syncShutdownGracefully</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">// Register another resource that should be started when the application starts</span>
<span class="c1">// and shut down when the application exits.</span>
<span class="c1">//</span>
<span class="c1">// In this case, we are registering a contrived `DatabaseMigrator`</span>
<span class="c1">// and passing its `migrate` function to be called on startup</span>
<span class="c1">// and `shutdown` function to be called on shutdown.</span>
<span class="k">let</span> <span class="nv">migrator</span> <span class="o">=</span> <span class="kt">DatabaseMigrator</span><span class="p">(</span><span class="nv">eventLoopGroup</span><span class="p">:</span> <span class="n">eventLoopGroup</span><span class="p">)</span>
<span class="n">lifecycle</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span>
    <span class="nv">name</span><span class="p">:</span> <span class="s">"migrator"</span><span class="p">,</span>
    <span class="nv">start</span><span class="p">:</span> <span class="o">.</span><span class="nf">async</span><span class="p">(</span><span class="n">migrator</span><span class="o">.</span><span class="n">migrate</span><span class="p">),</span>
    <span class="nv">shutdown</span><span class="p">:</span> <span class="o">.</span><span class="nf">async</span><span class="p">(</span><span class="n">migrator</span><span class="o">.</span><span class="n">shutdown</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">// Start the application.</span>
<span class="c1">//</span>
<span class="c1">// Start handlers passed using the `register` function</span>
<span class="c1">// will be called in the order they were registered in.</span>
<span class="n">lifecycle</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
    <span class="c1">// start completion handler</span>
    <span class="c1">// if an startup error occurred you can capture it here</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="nf">error</span><span class="p">(</span><span class="s">"failed starting </span><span class="se">\(</span><span class="k">self</span><span class="se">)</span><span class="s"> ‚ò†Ô∏è: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="k">self</span><span class="se">)</span><span class="s"> started successfully üöÄ"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Wait for the application to exit</span>
<span class="c1">//</span>
<span class="c1">// This is a blocking operation that typically waits for a `Signal`.</span>
<span class="c1">// The `Signal` can be configured at `lifecycle.init`, and defaults to `INT` and `TERM`.</span>
<span class="c1">// Shutdown handlers passed using the `register` or `registerShutdown` functions</span>
<span class="c1">// will be called in the reverse order they were registered in.</span>
<span class="n">lifecycle</span><span class="o">.</span><span class="nf">wait</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="getting-involved">Getting Involved</h2>

<p>If you are interested in Service Lifecycle, come and get involved!</p>

<p>The <a href="https://github.com/swift-server/swift-service-lifecycle">source is available</a>, and we encourage contributions from the open source community. If you have feedback, questions or would like to discuss the project, please feel free to chat on the <a href="https://forums.swift.org/c/server">Swift forums</a>. If you would like to report bugs, please use <a href="https://github.com/swift-server/swift-service-launcher/issues">the GitHub issue tracker</a>. We look forward to working with you, and helping move the industry forward to a better, safer programming future.</p>
:ET